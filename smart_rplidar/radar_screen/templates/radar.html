{% load static %}
<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'>
        <meta name='viewport' content='width=device-width,initial-scale=1'>
        <style type="text/css">
            /*
              This canvas background-color is not controlled by Scrawl-canvas
              â€” We will hide it in due course
            */
            canvas {
              background-color: black;
              width: 100%;
              height: 100%;
            }
            .canvas-host {
                overflow: hidden;
                border: 1px solid red;
                width: 70vh;
                height: 70vh;
                margin: 0 auto;
                background-color: #444;
                aspect-ratio: 1 / 1;
            }
          </style>
    </head>
<body>

    <h2>Radar Screen</h2>
    <div class="canvas-host">
        <canvas 
        id="display"
        width="400"
        height="400"
        data-scrawl-canvas
        data-is-responsive="true"
        data-base-width="1000"
        data-base-height="1000"
        data-fit="contain"
        ></canvas>
    </div>

</body>
<script type="text/javascript" src="{% static 'js/websocket_handler.js' %}"></script>
<script type="module">
    import * as scrawl from "{% static 'js/scrawl.js' %}";

    // define display element
    const canvas = scrawl.library.canvas["display"];

    // Namespacing boilerplate
    const namespace = 'radar-display';
    const name = (n) => `${namespace}-${n}`;

    canvas.set({
        backgroundColor: 'honeydew',
      }).setAsCurrentCanvas();
    
    var draw_hud = function(){
        scrawl.makeBlock({
            name: name('box'),
        
            startX: "50%",
            startY: "50%",
            handleX: "50%",
            handleY: "50%",
            width: "25%",
            height: "25%",

            fillStyle: "red"
          });
    }
    var draw_points = function(scan_data){
        var max_dist = 6000;
        for(var i = 0; i < scan_data.length; i++){
            var data = scan_data[i]
            var x = `${((data.x/max_dist)+0.5)*100}%`
            var y = `${((data.y/max_dist)+0.5)*100}%`
            scrawl.makeBlock({
                name: name("point"),
                startX: x,
                startY: y,
                handleX: "50%",
                handleY: "50%",
                width: 10,
                height: 10,

                fillStyle: "blue"
            })
        }
    }

    scrawl.makeRender({
        name: name('animation'),
        target: canvas,
      });
    
    //draw_hud();
    //canvas.render();
    
    // define event callbacks
    var on_conn_close = function(event) {
        //display.innerText = display.textContent = "connection lost"
    }
    var on_conn_update = function(event) {
        var data = JSON.parse(event.data)[0]["scan_data"];
        draw_points(data) //[TODO] find a way to clear before redraw
        canvas.render();
    }
    var on_conn_timeout = function(event){
        //display.innerText = display.textContent = "connection timeout"
    }

    // initiate websocket handler
    var ws_url = "ws://" + window.location.host + "/ws/ticks/";
    var ticks = new WSHandler(ws_url);
    ticks.set_onmessage(on_conn_update);
    ticks.set_onclose(on_conn_close);
    ticks.set_ontimeout(on_conn_timeout);

</script>
</html>